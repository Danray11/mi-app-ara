<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca de PDFs por SAP</title>

  <!-- Librerías (solo para leer Excel y render PDF si lo necesitas) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js';
  </script>

  <style>
    :root{
      --ara-red:#EE3124; --ara-orange:#FF6A00; --bg:#f5f6f8; --card:#fff; --text:#20232a;
      --muted:#6c757d; --accent:linear-gradient(90deg,var(--ara-red),var(--ara-orange));
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--accent);color:#fff;padding:16px 20px;font-weight:800;letter-spacing:.2px}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 25px rgba(16,24,40,.06);padding:18px}
    h2{margin:0 0 12px 0;font-size:18px}
    label{font-weight:600;font-size:14px;margin-top:8px;display:block}
    input[type="text"],input[type="number"],select{
      width:100%;padding:10px 12px;border:1px solid #e4e6eb;border-radius:10px;background:#fff
    }
    input[type="file"]{width:100%}
    .btn{display:inline-block;width:100%;padding:12px 14px;border-radius:12px;border:0;
         color:#fff;background:var(--accent);font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:var(--ara-red);border:2px solid var(--ara-red)}
    .muted{color:var(--muted);font-size:13px}
    .status-ok{color:#198754}.status-bad{color:#dc3545}
    #pdfViewer{border:1px solid #e7e9ee;border-radius:12px;min-height:220px;display:grid;place-items:center;color:#94a3b8}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .pill{display:inline-block;background:#fff3cd;color:#8a6d3b;border-radius:999px;padding:6px 12px;font-size:12px}
  </style>
</head>
<body>
  <header>Biblioteca de PDFs por SAP</header>

  <div class="wrap grid">
    <!-- 1) Estado de datos en la nube -->
    <section class="card">
      <h2>Estado de datos en la nube</h2>
      <div class="muted" id="cloudStatus">
        Excel: <span id="excelState" class="status-bad">no encontrado</span>.
        Carpeta PDFs base: <span id="pdfBaseText">—</span>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-outline" id="btnReloadCloud">Reintentar carga</button>
        <span class="pill" id="brandInfo" style="margin-left:8px">Leyendo desde Netlify Blobs</span>
      </div>
    </section>

    <!-- 2) Administrador: subir y publicar -->
    <section class="card">
      <h2>Administrador — Cargar local y publicar en la nube</h2>

      <div class="grid two">
        <div>
          <label>1) Cargar Excel (local)</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />
          <div class="muted" id="excelLocalName">Excel local: —</div>
        </div>

        <div>
          <label>2) Seleccionar PDFs (local)</label>
          <input type="file" id="pdfFolder" multiple webkitdirectory />
          <div class="muted"><span id="pdfCount">0</span> PDF(s) listos</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnPublish">Publicar en la nube</button>
      </div>

      <div class="muted" id="publishMsg" style="margin-top:8px"></div>
    </section>

    <!-- 3) Búsqueda (simple demo) -->
    <section class="card">
      <h2>Buscar por SAP</h2>
      <div class="grid two">
        <div>
          <label>Ingresar SAP</label>
          <input type="number" id="sapNumber" placeholder="Ej. 5"/>
        </div>
        <div>
          <label>Seleccionar Categoría</label>
          <select id="categorySelect">
            <option value="">—</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnSearch">Buscar PDF</button>
      </div>
    </section>

    <!-- 4) Visor -->
    <section class="card">
      <h2>Visor</h2>
      <div id="pdfViewer">Selecciona y busca para previsualizar</div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-outline" id="btnOpen" disabled>Abrir en pestaña nueva</button>
        <button class="btn btn-outline" id="btnDownload" disabled>Descargar</button>
      </div>
    </section>
  </div>

  <script>
    // ==========================================================
    //  A. Estado/Variables globales
    // ==========================================================
    let excelMatrix = [];           // matriz con el Excel cargado desde blobs
    let headers = [];               // cabecera del excel
    let blobsBase = `${location.origin}/.netlify/blobs/`; // base por defecto
    let lastFoundPdfKey = null;     // última clave PDF encontrada (para abrir/descargar)

    const $ = (id)=>document.getElementById(id);

    // Lee el value devuelto por publish (si lo hubo en esta sesión)
    if (window.__BLOBS_BASE_URL__) blobsBase = window.__BLOBS_BASE_URL__;
    $('pdfBaseText').textContent = blobsBase + 'pdfs/';

    // ==========================================================
    //  B. Helpers
    // ==========================================================
    function setMsg(el, msg, ok=false){
      el.textContent = msg;
      el.style.color = ok ? '#198754' : '#dc3545';
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload=()=>{ 
          const s = String(r.result||'');
          const base64 = s.includes(',') ? s.split(',')[1] : s;
          resolve(base64);
        };
        r.onerror=reject;
        r.readAsDataURL(file);
      });
    }

    function sheetToMatrix(workbook){
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(sheet, {header:1, blankrows:false});
    }

    // ==========================================================
    //  C. Publicar en la nube (JSON base64 → Netlify Blobs)
    // ==========================================================
    $('excelFile').addEventListener('change', e=>{
      $('excelLocalName').textContent = e.target.files[0] ? `Excel local: ${e.target.files[0].name}` : 'Excel local: —';
    });

    $('pdfFolder').addEventListener('change', e=>{
      $('pdfCount').textContent = e.target.files.length;
    });

    $('btnPublish').addEventListener('click', publicarEnLaNube);

    async function publicarEnLaNube(){
      const excelFile = $('excelFile').files[0] || null;
      const pdfFiles = Array.from($('pdfFolder').files || []);

      if(!excelFile && pdfFiles.length===0){
        setMsg($('publishMsg'), 'Selecciona al menos un archivo.', false); return;
      }

      $('btnPublish').disabled = true;
      setMsg($('publishMsg'), 'Publicando…', true);

      try{
        const body = { excel:null, pdfs:[] };

        if(excelFile){
          body.excel = {
            name: excelFile.name,
            contentBase64: await fileToBase64(excelFile)
          };
        }
        for(const f of pdfFiles){
          // sólo PDFs
          if ((f.type||'').includes('pdf') || f.name.toLowerCase().endsWith('.pdf')){
            body.pdfs.push({
              name: f.name,
              contentBase64: await fileToBase64(f)
            });
          }
        }

        const resp = await fetch('/.netlify/functions/publish', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        const text = await resp.text();
        let json;
        try { json = JSON.parse(text); } catch { json = {ok:false, raw:text}; }

        if(resp.ok && json.ok){
          // guardamos baseUrl que devuelve la función
          blobsBase = (json.baseUrl || blobsBase);
          window.__BLOBS_BASE_URL__ = blobsBase;
          $('pdfBaseText').textContent = blobsBase + 'pdfs/';
          setMsg($('publishMsg'), 'Archivos publicados correctamente.', true);
        }else{
          console.log('publish response:', text);
          setMsg($('publishMsg'), 'Error al publicar. Revisa consola.', false);
        }
      }catch(err){
        console.error(err);
        setMsg($('publishMsg'), 'Error inesperado. Revisa consola.', false);
      }finally{
        $('btnPublish').disabled = false;
      }
    }

    // ==========================================================
    //  D. Cargar Excel desde BLOBS y poblar categorías
    // ==========================================================
    $('btnReloadCloud').addEventListener('click', loadExcelFromCloud);

    async function loadExcelFromCloud(){
      const excelUrl = `${blobsBase}excel/Layout.xlsx`;
      $('excelState').textContent = 'buscando…';
      $('excelState').className = 'status-bad';

      try{
        const res = await fetch(excelUrl);
        if(!res.ok) { $('excelState').textContent = 'no encontrado'; return; }

        const ab = await res.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(ab), {type:'array'});
        excelMatrix = sheetToMatrix(wb);

        if(!excelMatrix.length){ $('excelState').textContent='vacío'; return; }

        headers = excelMatrix[0].map(h=>(h||'').toString().trim());
        $('excelState').textContent = 'ok';
        $('excelState').className = 'status-ok';

        // Poblar categorías (todas las columnas, desde TIPOLGÍA+1 o las últimas columnas de nombres)
        // Si ya sabes el índice, cámbialo aquí:
        const idxTipologia = headers.findIndex(h=>/^TIPOLOGIA$/i.test(h));
        const catStart = idxTipologia >=0 ? idxTipologia+1 : Math.max(5, headers.length-3);
        const cats = headers.slice(catStart).filter(Boolean);
        const sel = $('categorySelect');
        sel.innerHTML = '<option value="">—</option>';
        cats.forEach(c=>{
          const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
        });
      }catch(e){
        console.error(e);
        $('excelState').textContent = 'error';
      }
    }

    // cargar al entrar
    loadExcelFromCloud();

    // ==========================================================
    //  E. Buscar PDF: cruza SAP + categoría contra el Excel
    //     y construye la URL desde BLOBS
    // ==========================================================
    $('btnSearch').addEventListener('click', ()=>{
      const sap = String($('sapNumber').value||'').trim();
      const cat = $('categorySelect').value || '';
      if(!sap || !cat){ alert('Ingresa SAP y categoría.'); return; }
      if(excelMatrix.length<2){ alert('Primero carga el Excel desde la nube.'); return; }

      // En tus matrices reales, ubica la columna SAP y la columna de la categoría:
      const idxSAP = headers.findIndex(h=>/^SAP$/i.test(h));
      const idxCat = headers.findIndex(h=>h===cat);

      if(idxSAP<0 || idxCat<0){ alert('No se encontraron columnas SAP/categoría.'); return; }

      // Buscar fila por SAP
      const row = excelMatrix.find((r,i)=> i>0 && String(r[idxSAP]||'').trim()===sap);
      if(!row){ alert('SAP no encontrado en el Excel.'); return; }

      const fileStem = (row[idxCat]||'').toString().trim(); // ejemplo: GALLETAS_P3_ZO_R1_04_4
      if(!fileStem){ alert('No hay nombre de archivo para esa categoría.'); return; }

      // Construye clave de blob (agrega .pdf si no viene)
      const pdfKey = `pdfs/${fileStem.toLowerCase().endsWith('.pdf')? fileStem : fileStem + '.pdf'}`;
      const pdfUrl = blobsBase + pdfKey;

      lastFoundPdfKey = pdfKey;
      renderPdfPreview(pdfUrl);
    });

    // Render sencillo con pdf.js
    async function renderPdfPreview(url){
      const $v = $('pdfViewer');
      $v.innerHTML = 'Cargando PDF…';
      try{
        const pdf = await pdfjsLib.getDocument(url).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale:1.2});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({canvasContext:ctx, viewport}).promise;
        $v.innerHTML = ''; $v.appendChild(canvas);
        $('btnOpen').disabled = false;
        $('btnDownload').disabled = false;
      }catch(e){
        console.error(e);
        $v.innerHTML = '<span class="status-bad">No se pudo renderizar el PDF.</span>';
        $('btnOpen').disabled = false;
        $('btnDownload').disabled = false;
      }
    }

    // Abrir y descargar
    $('btnOpen').addEventListener('click', ()=>{
      if(!lastFoundPdfKey) return;
      const url = blobsBase + lastFoundPdfKey;
      window.open(url,'_blank');
    });

    $('btnDownload').addEventListener('click', ()=>{
      if(!lastFoundPdfKey) return;
      const url = blobsBase + lastFoundPdfKey;
      const a = document.createElement('a');
      a.href = url; a.download = lastFoundPdfKey.split('/').pop(); a.click();
    });
  </script>
</body>
</html>
