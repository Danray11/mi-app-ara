<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca de PDFs por SAP — ARA</title>

  <meta name="theme-color" content="#ED1C24" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js';
  </script>

  <style>
    :root{
      --red:#ED1C24; --orange:#FF7A00; --green:#2BB673;
      --bg:#F7F8FB; --card:#FFFFFF; --text:#1F2937; --muted:#6B7280; --border:#E5E7EB;
      --shadow:0 10px 25px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 22px;background:linear-gradient(90deg,var(--red),var(--orange));color:#fff;
      box-shadow:var(--shadow);position:sticky;top:0;z-index:10
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;width:auto;display:block}
    .brand h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .container{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
    label{font-weight:600;margin:8px 0 6px;display:block}
    input[type="file"],input[type="text"],select,button{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#FFF;color:var(--text);
      outline:none;transition:box-shadow .2s,border-color .2s
    }
    input:focus,select:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(43,182,115,.15)}
    .row{display:flex;gap:12px;align-items:flex-end}
    .row>*{flex:1}
    .btn-primary{
      background:linear-gradient(90deg,var(--red),var(--orange));color:#fff;border:none;font-weight:700;cursor:pointer
    }
    .btn-primary:hover{filter:brightness(.98)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    #pdfViewer{min-height:65vh;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:10px}
    #pdfViewer canvas{display:block;margin:12px auto;max-width:100%;height:auto}
    .small{font-size:12px;color:var(--muted)}
    .ok{color:#2BB673}.bad{color:#ED1C24}
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <img src="Logo_ARA.png" alt="ARA" />
      <h1>Biblioteca de PDFs por SAP</h1>
    </div>
  </header>

  <main class="container">
    <!-- ESTADO EN LA NUBE -->
    <section class="card">
      <div class="row">
        <div>
          <label>Estado de datos en la nube</label>
          <div id="excelStatus" class="small">Excel: comprobando…</div>
          <div id="pdfBaseStatus" class="small">Carpeta PDFs en nube: <code id="pdfBasePath">…</code></div>
        </div>
        <div style="max-width:220px">
          <label>&nbsp;</label>
          <button id="retryCloud" class="btn-primary">Reintentar carga</button>
        </div>
      </div>
    </section>

    <!-- ADMIN: CARGAR LOCAL + PUBLICAR -->
    <section class="card">
      <h3 style="margin:0 0 10px 0;font-size:16px">Administrador — Cargar local y publicar en la nube</h3>
      <div class="row">
        <div>
          <label>Cargar Excel (local)</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />
          <div id="excelHint" class="small"></div>
        </div>
        <div>
          <label>Seleccionar carpeta con PDFs (local)</label>
          <input type="file" id="pdfFolder" webkitdirectory directory multiple />
          <div id="pdfHint" class="small"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Ruta Excel en repo</label>
          <input id="cloudExcelPath" type="text" value="data/Layout.xlsx" />
        </div>
        <div>
          <label>Carpeta PDFs en repo</label>
          <input id="cloudPdfBase" type="text" value="pdfs/" />
        </div>
        <div style="max-width:220px">
          <label>&nbsp;</label>
          <button id="publishBtn" class="btn-primary">Publicar en la nube</button>
        </div>
      </div>
      <div id="publishStatus" class="small" style="margin-top:8px"></div>
    </section>

    <!-- BÚSQUEDA -->
    <section class="card">
      <div class="row">
        <div>
          <label>Ingresar SAP</label>
          <input type="text" id="sapNumber" placeholder="Ej. 5" />
        </div>
        <div>
          <label>Seleccionar Categoría</label>
          <select id="categorySelect"><option value="">—</option></select>
        </div>
      </div>

      <div class="toolbar">
        <button id="searchBtn" class="btn-primary">Buscar PDF</button>
        <button id="openNewTab" disabled>Abrir en pestaña nueva</button>
        <button id="downloadBtn" disabled>Descargar</button>
        <span id="currentName" class="small"></span>
      </div>
    </section>

    <!-- VISOR -->
    <section id="pdfViewer" class="card">Sin documento</section>
  </main>

  <script>
    /******** CONFIG DE NUBE (GitHub Pages) ********/
    // Cuando tengas tu repo público con Pages activo, cambia estas URLs:
    const EXCEL_URLS = [
      './data/Layout.xlsx',
      './data/layout.xlsx'
      // Ejemplo final: 'https://TU_USUARIO.github.io/TU_REPO/data/Layout.xlsx'
    ];
    const PDF_BASE_URL = './pdfs/'; // Ejemplo final: 'https://TU_USUARIO.github.io/TU_REPO/pdfs/'

    /******** HELPERS ********/
    const $ = (sel) => document.querySelector(sel);
    const norm = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const toBase = (s) => norm(s).replace(/\.[^/.]+$/,'');   // sin extensión

    /******** ESTADO ********/
    let excelData = [];  let headerRow = [];  let COL = {};
    let lastPdfUrl = null; let lastFileName = null;

    // ======== CARGA EXCEL DESDE NUBE ========
    async function tryLoadExcel(){
      $('#excelStatus').textContent = 'Excel: comprobando…';
      for (const url of EXCEL_URLS){
        try{
          const res = await fetch(url, { cache:'no-store' });
          if(!res.ok) continue;
          const arr = await res.arrayBuffer();
          const wb = XLSX.read(new Uint8Array(arr), { type:'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          excelData = XLSX.utils.sheet_to_json(sheet, { header:1 }) || [];
          if(!excelData.length) { $('#excelStatus').innerHTML = 'Excel: <span class="bad">hoja vacía</span>'; return false; }

          headerRow = (excelData[0]||[]).map(h => (h||'').toString().trim());
          COL = {
            REGION:    headerRow.findIndex(h => /REGIÓN|REGION/i.test(h)),
            Z:         headerRow.findIndex(h => /^Z$/i.test(h)),
            SAP:       headerRow.findIndex(h => /^SAP$/i.test(h)),
            SURTIDO:   headerRow.findIndex(h => /^SURTIDO$/i.test(h)),
            TIPOLOGIA: headerRow.findIndex(h => /^TIPOLOGIA$/i.test(h))
          };
          if (COL.TIPOLOGIA < 0) { $('#excelStatus').innerHTML = 'Excel: <span class="bad">falta columna TIPOLOGIA</span>'; return false; }

          const cats = headerRow.slice(COL.TIPOLOGIA+1).filter(Boolean);
          $('#categorySelect').innerHTML = '<option value="">—</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
          $('#excelStatus').innerHTML = `Excel: <span class="ok">cargado</span> (${cats.length} categorías)`;
          return true;
        }catch(e){ /* intenta siguiente URL */ }
      }
      $('#excelStatus').innerHTML = 'Excel: <span class="bad">no encontrado</span>. Publica <code>data/Layout.xlsx</code>.';
      return false;
    }

    // ======== ADMIN: CARGAR LOCAL (para publicar) ========
    document.getElementById('excelFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      document.getElementById('excelHint').textContent = f ? `Excel local: ${f.name}` : '';
    });

    document.getElementById('pdfFolder').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files||[]).filter(f => /\.pdf$/i.test(f.name.trim()));
      document.getElementById('pdfHint').textContent = files.length ? `${files.length} PDF(s) listos para publicar` : '';
    });

    // ======== PUBLICAR EN LA NUBE (Netlify Function) ========
    async function publishToCloud(){
      const excelInput = document.getElementById('excelFile');
      const pdfInput   = document.getElementById('pdfFolder');
      const excelPath  = document.getElementById('cloudExcelPath').value || 'data/Layout.xlsx';
      const pdfBase    = document.getElementById('cloudPdfBase').value || 'pdfs/';
      const statusEl   = document.getElementById('publishStatus');

      if (!pdfInput.files || pdfInput.files.length === 0) {
        alert('Selecciona la carpeta de PDFs antes de publicar.');
        return;
      }

      statusEl.textContent = 'Preparando archivos…';

      const form = new FormData();
      if (excelInput.files && excelInput.files[0]) form.append('excel', excelInput.files[0], excelInput.files[0].name);
      for (const f of Array.from(pdfInput.files)) form.append('pdfs', f, f.name);
      form.append('excelPath', excelPath);
      form.append('pdfBase', pdfBase);

      try {
        statusEl.textContent = 'Subiendo a la nube… (puede tardar)';
        const res = await fetch('/.netlify/functions/publish', { method: 'POST', body: form });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(JSON.stringify(data));
        statusEl.textContent = `Publicado: ${data.uploaded.length} archivo(s).`;

        // Refresca el Excel desde la nube para que quede activo ya
        await tryLoadExcel();
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Error al publicar. Revisa la consola.';
      }
    }
    document.getElementById('publishBtn').addEventListener('click', (e)=>{ e.preventDefault(); publishToCloud(); });

    // ======== BÚSQUEDA: SAP + Categoría (desde nube) ========
    async function searchAndOpen(){
      if(!excelData.length){ alert('El Excel en la nube no está disponible. Publica o reintenta.'); return; }
      const sap = document.getElementById('sapNumber').value?.toString().trim();
      const cat = document.getElementById('categorySelect').value;
      if(!sap) return alert('Ingresa SAP.');
      if(!cat) return alert('Selecciona una categoría.');
      if(COL.SAP < 0) return alert('No se encontró la columna SAP en el Excel.');

      const row = excelData.find((r,i)=> i>0 && String(r[COL.SAP])===sap);
      if(!row) return alert('SAP no encontrado en el Excel.');

      const colIndex = headerRow.findIndex(h => String(h).trim()===cat);
      if(colIndex<0) return alert('Categoría no encontrada en encabezados.');

      const cellVal = (row[colIndex]||'').toString().trim();
      if(!cellVal) return alert('La celda para esa categoría está vacía.');

      const base = toBase(cellVal);
      const candidates = [
        PDF_BASE_URL + encodeURIComponent(base) + '.pdf',
        PDF_BASE_URL + encodeURIComponent(cellVal)
      ];

      let found = null, name = null;
      for (const url of candidates){
        try{
          const head = await fetch(url, { method:'HEAD', cache:'no-store' });
          if(head.ok){ found = url; name = decodeURIComponent(url.split('/').pop()); break; }
        }catch(e){ /* sigue */ }
      }

      if(!found){
        alert(`No se encontró el PDF en la nube:\n- Esperado: ${PDF_BASE_URL}${base}.pdf`);
        return;
      }

      lastPdfUrl = found;
      lastFileName = name;
      document.getElementById('currentName').textContent = name;
      document.getElementById('openNewTab').disabled = false;
      document.getElementById('downloadBtn').disabled = false;

      await renderPdfFromUrl(found);
    }
    document.getElementById('searchBtn').addEventListener('click', searchAndOpen);

    // ======== RENDER PDF DESDE URL ========
    async function renderPdfFromUrl(url){
      const viewer = document.getElementById('pdfViewer');
      viewer.innerHTML = 'Cargando…';
      try{
        const pdf = await pdfjsLib.getDocument(url).promise;
        viewer.innerHTML = '';
        for(let n=1;n<=pdf.numPages;n++){
          const page = await pdf.getPage(n);
          const viewport = page.getViewport({scale:1.25});
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({canvasContext:ctx, viewport}).promise;
          viewer.appendChild(canvas);
        }
      }catch(err){
        console.error('PDF.js error:', err);
        viewer.innerHTML = 'No se pudo mostrar el PDF aquí. Usa los botones para abrir o descargar.';
      }
    }

    // ======== BOTONES abrir/descargar ========
    document.getElementById('openNewTab').addEventListener('click', ()=>{ if(lastPdfUrl) window.open(lastPdfUrl,'_blank','noopener'); });
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      if(!lastPdfUrl) return;
      const a = document.createElement('a');
      a.href = lastPdfUrl;
      a.download = lastFileName || 'documento.pdf';
      a.click();
    });

    // ======== REINTENTAR CARGA EN NUBE ========
    document.getElementById('retryCloud').addEventListener('click', tryLoadExcel);

    // Inicial
    document.getElementById('pdfBasePath').textContent = PDF_BASE_URL;
    tryLoadExcel();
  </script>
</body>
</html>
