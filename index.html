<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca de PDFs por SAP — ARA</title>

  <meta name="theme-color" content="#ED1C24" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js';
  </script>

  <style>
    :root{
      --red:#ED1C24; --orange:#FF7A00; --green:#2BB673;
      --bg:#F7F8FB; --card:#FFFFFF; --text:#1F2937; --muted:#6B7280; --border:#E5E7EB;
      --shadow:0 10px 25px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 22px;background:linear-gradient(90deg,var(--red),var(--orange));color:#fff;
      box-shadow:var(--shadow);position:sticky;top:0;z-index:10
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;width:auto;display:block}
    .brand h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .actions{display:flex;gap:10px;align-items:center}
    .badge{padding:8px 12px;border:1px solid rgba(255,255,255,.35);border-radius:999px;background:rgba(255,255,255,.18);}
    .btn-ghost{cursor:pointer}
    .container{max-width:1100px;margin:22px auto;padding:0 16px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
    label{font-weight:600;margin:8px 0 6px;display:block}
    input[type="file"],input[type="text"],select,button{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#FFF;color:var(--text);
      outline:none;transition:box-shadow .2s,border-color .2s
    }
    input:focus,select:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(43,182,115,.15)}
    .row{display:flex;gap:12px;align-items:flex-end}
    .row>*{flex:1}
    .btn-primary{
      background:linear-gradient(90deg,var(--red),var(--orange));color:#fff;border:none;font-weight:700;cursor:pointer
    }
    .btn-primary:hover{filter:brightness(.98)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    #pdfViewer{min-height:65vh;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:10px}
    #pdfViewer canvas{display:block;margin:12px auto;max-width:100%;height:auto}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <!-- Usa el archivo con este nombre exacto, junto al index.html -->
      <img src="Logo_ARA.png" alt="ARA" />
      <h1>Biblioteca de PDFs por SAP</h1>
    </div>
    <div class="actions">
      <span id="roleBadge" class="badge">Rol: —</span>
      <button id="switchRole" class="badge btn-ghost">Cambiar rol</button>
    </div>
  </header>

  <main class="container">
    <!-- ADMIN -->
    <section class="card" id="adminBlock">
      <div class="row">
        <div>
          <label>Cargar Excel (solo Administrador)</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />
          <div id="excelHint" class="small"></div>
        </div>
        <div>
          <label>Seleccionar carpeta con PDFs (solo Administrador)</label>
          <input type="file" id="pdfFolder" webkitdirectory directory multiple />
          <div id="pdfHint" class="small"></div>
        </div>
      </div>
    </section>

    <!-- COMÚN -->
    <section class="card">
      <div class="row">
        <div>
          <label>Ingresar SAP</label>
          <input type="text" id="sapNumber" placeholder="Ej. 5" />
        </div>
        <div>
          <label>Seleccionar Categoría</label>
          <select id="categorySelect"><option value="">—</option></select>
        </div>
      </div>

      <div class="toolbar">
        <button id="searchBtn" class="btn-primary">Buscar PDF</button>
        <button id="openNewTab" disabled>Abrir en pestaña nueva</button>
        <button id="downloadBtn" disabled>Descargar</button>
        <span id="currentName" class="small"></span>
      </div>
    </section>

    <section id="pdfViewer" class="card">Sin documento</section>
  </main>

  <script>
    /******** CONFIG ********/
    const ADMIN_PIN = 'admin123'; // cámbialo si quieres

    /******** HELPERS ********/
    const $ = (sel) => document.querySelector(sel);
    const normalize = (s) => String(s||'')
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\.[^.]+$/,'')
      .replace(/[\s_-]+/g,'')
      .toLowerCase().trim();

    /******** ESTADO ********/
    let role = localStorage.getItem('pdfsap_role') || 'admin'; // empieza en admin para configurar
    let excelData = [];  let headerRow = [];  let _col = {};
    let pdfFiles = {};  let lastFile = null; let lastBlobURL = null;

    /******** ROLES ********/
    function applyRoleUI(){
      const isAdmin = role === 'admin';
      $('#roleBadge').textContent = 'Rol: ' + (isAdmin ? 'Administrador' : 'Tienda');
      $('#adminBlock').style.display = isAdmin ? '' : 'none';
      $('#excelFile').disabled = !isAdmin;
      $('#pdfFolder').disabled = !isAdmin;
    }
    applyRoleUI();

    $('#switchRole').addEventListener('click', ()=>{
      if(role === 'admin'){
        role = 'tienda';
        localStorage.setItem('pdfsap_role', role);
        applyRoleUI();
      }else{
        const pin = prompt('PIN de administrador:');
        if(pin === ADMIN_PIN){
          role = 'admin';
          localStorage.setItem('pdfsap_role', role);
          applyRoleUI();
        }else if(pin!==null){
          alert('PIN incorrecto');
        }
      }
    });

    /******** EVENTOS ********/
    $('#excelFile').addEventListener('change', handleExcel);
    $('#pdfFolder').addEventListener('change', handlePDFFolder);
    $('#searchBtn').addEventListener('click', searchPDF);
    $('#openNewTab').addEventListener('click', ()=>{ if(lastBlobURL) window.open(lastBlobURL,'_blank','noopener'); });
    $('#downloadBtn').addEventListener('click', ()=>{
      if(!lastFile) return;
      const url = lastBlobURL || URL.createObjectURL(lastFile);
      const a=document.createElement('a'); a.href=url; a.download=lastFile.name; a.click();
    });

    /******** EXCEL ********/
    function handleExcel(evt){
      const file = evt.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(sheet,{header:1}) || [];
        if(!excelData.length){ $('#excelHint').textContent = 'Hoja vacía.'; $('#categorySelect').innerHTML='<option value=\"\">—</option>'; return; }

        headerRow = (excelData[0]||[]).map(h => (h||'').toString().trim());
        _col = {
          REGION:    headerRow.findIndex(h => /REGIÓN|REGION/i.test(h)),
          Z:         headerRow.findIndex(h => /^Z$/i.test(h)),
          SAP:       headerRow.findIndex(h => /^SAP$/i.test(h)),
          SURTIDO:   headerRow.findIndex(h => /^SURTIDO$/i.test(h)),
          TIPOLOGIA: headerRow.findIndex(h => /^TIPOLOGIA$/i.test(h))
        };
        if(_col.TIPOLOGIA<0){ $('#excelHint').textContent='Falta columna TIPOLOGIA.'; $('#categorySelect').innerHTML='<option value=\"\">—</option>'; return; }

        const cats = headerRow.slice(_col.TIPOLOGIA+1).filter(Boolean);
        $('#categorySelect').innerHTML = '<option value=\"\">—</option>' + cats.map(c=>`<option value=\"${c}\">${c}</option>`).join('');
        $('#excelHint').textContent = '';
      };
      reader.readAsArrayBuffer(file);
    }

    /******** PDFs ********/
    function handlePDFFolder(evt){
      const files = Array.from(evt.target.files||[]);
      pdfFiles = {};
      let matched = 0;
      for(const file of files){
        const byMime = (file.type||'').toLowerCase()==='application/pdf';
        const byName = /\.pdf$/i.test(file.name.trim());
        if(!(byMime||byName)) continue;
        const base = file.name.trim().replace(/\.[^/.]+$/,'');
        pdfFiles[base] = file;
        pdfFiles['__norm__'+normalize(base)] = file;
        matched++;
      }
      $('#pdfHint').textContent = matched ? `${matched} PDF(s) indexados` : '';
    }

    /******** BÚSQUEDA ********/
    async function searchPDF(){
      if(!excelData.length) return alert('Primero carga el Excel (Administrador).');
      const count = Object.keys(pdfFiles).filter(k=>!k.startsWith('__norm__')).length;
      if(!count) return alert('Primero indexa la carpeta de PDFs (Administrador).');

      const sap = $('#sapNumber').value?.toString().trim();
      const category = $('#categorySelect').value;
      if(!sap) return alert('Ingresa SAP.');
      if(!category) return alert('Selecciona una categoría.');
      if(_col.SAP<0) return alert('No se encontró la columna SAP en el Excel.');

      const row = excelData.find((r,i)=> i>0 && String(r[_col.SAP])===sap);
      if(!row) return alert('SAP no encontrado en el Excel.');

      const colIndex = headerRow.findIndex(h => String(h).trim()===category);
      if(colIndex<0) return alert('Categoría no encontrada en encabezados.');

      const baseRaw = (row[colIndex]||'').toString().trim();
      if(!baseRaw) return alert('La celda para esa categoría está vacía.');

      const baseExact = baseRaw.replace(/\.[^/.]+$/,'');
      const baseNorm  = normalize(baseExact);

      let file = pdfFiles[baseExact] || pdfFiles['__norm__'+baseNorm];
      if(!file){
        const keys = Object.keys(pdfFiles).filter(k=>!k.startsWith('__norm__'));
        const candidates = keys.filter(k=> normalize(k).includes(baseNorm)).slice(0,12);
        return alert(candidates.length ? 'No hubo match exacto. Sugerencias:\n'+candidates.join('\n')
                                      : `No se encontró PDF: ${baseRaw}`);
      }

      await renderPDF(file);
    }

    /******** VISOR PDF + FALLBACK (sin duplicar botones) ********/
    async function renderPDF(file){
      const viewer = $('#pdfViewer');
      viewer.innerHTML = 'Cargando…';
      if(lastBlobURL){ URL.revokeObjectURL(lastBlobURL); lastBlobURL=null; }
      lastFile = file;

      try{
        const data = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data}).promise;
        viewer.innerHTML = '';
        for(let n=1;n<=pdf.numPages;n++){
          const page = await pdf.getPage(n);
          const viewport = page.getViewport({scale:1.25});
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({canvasContext:ctx, viewport}).promise;
          viewer.appendChild(canvas);
        }
        // habilitar toolbar superior
        $('#openNewTab').disabled = false;
        $('#downloadBtn').disabled = false;
        lastBlobURL = URL.createObjectURL(file);
        $('#currentName').textContent = file.name;
      }catch(err){
        console.error('PDF.js error:', err);
        // sin inyectar más botones: usamos los de la toolbar
        lastBlobURL = URL.createObjectURL(file);
        viewer.innerHTML = 'No se pudo mostrar el PDF aquí. Usa los botones de arriba para abrir o descargar.';
        $('#openNewTab').disabled = false;
        $('#downloadBtn').disabled = false;
        $('#currentName').textContent = file.name;
      }
    }
  </script>
</body>
</html>

